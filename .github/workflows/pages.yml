# SPDX-FileCopyrightText: 2024 CSC - IT Center for Science Ltd. <www.csc.fi>
#
# SPDX-License-Identifier: MIT

# Script based on examples in https://github.com/actions/starter-workflows/tree/main/pages
name: Deploy slides to Pages

on:
  workflow_call:
    inputs:
      include_pdf:
        required: true
        type: boolean

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/csc-training/slidefactory:3.4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Build slides
        env:
          INCLUDE_PDF: ${{ inputs.include_pdf }}
        shell: bash
        run: |
          git config --global --add safe.directory $PWD
          GIT_SHORT_SHA=$(git rev-parse --short $GITHUB_SHA)
          GIT_DATE=$(git show -s --format=%ci $GITHUB_SHA)

          ARGS=""
          [[ "$INCLUDE_PDF" == "true" ]] && ARGS="--with-pdf"

          slidefactory pages about.yml build \
              --filters tools/mpi_links.py \
              --info_content "Updated for [$GIT_SHORT_SHA]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$GITHUB_SHA) ($GIT_DATE)" \
              $ARGS

      - name: Merge previous site and new build
        shell: bash
        run: |
          # Download previous site
          wget -q "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/site.zip" || echo "Downloading previous site failed"

          # Prepare site directory
          if [ -f site.zip ]; then
              unzip -q site.zip
              rm site.zip
          else
              mkdir site
          fi

          # Update current branch
          rm -rf site/${{ github.ref_name }}
          mv build site/${{ github.ref_name }}

          # Add redirecting index.html at the root
          cat > site/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <meta http-equiv="refresh" content="0; url=./main/" />
            <script>
              window.location.replace('./main/');
            </script>
            <title>Redirecting</title>
          </head>
          <body>
            <p>Redirecting to <a href="./main/">main</a></p>
          </body>
          </html>
          EOF

          # Remove pages for deleted branches
          find site -mindepth 1 -maxdepth 1 -type d | while read -r dir; do
              branch=$(basename "$dir")

              if ! wget -q --spider https://api.github.com/repos/${{ github.repository }}/branches/$branch; then
                  echo "branch $branch removed"
                  rm -rf "$dir"
              fi
          done

          # Repack site
          zip -r site site/
          mv site.zip site/

      - name: Upload artifact for pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
